---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout
  title="Qã¡ã‚ƒã‚“ - TGN AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ"
  description="TGNã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€ŒQã¡ã‚ƒã‚“ã€ã«ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã€‚TGNã®æ´»å‹•ã€å‚åŠ æ–¹æ³•ã€ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ãªã©ã€ãŠæ°—è»½ã«ã”è³ªå•ãã ã•ã„ã€‚"
>
  <div class="min-h-[calc(100vh-200px)] flex flex-col bg-gradient-to-br from-primary/5 to-secondary/5">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="bg-white border-b shadow-sm sticky top-0 z-10">
      <div class="container py-4">
        <div class="flex items-center gap-4">
          <img
            src="/images/QxQ-02.png"
            alt="Qã¡ã‚ƒã‚“"
            class="w-12 h-12 rounded-full border-2 border-primary shadow-md"
          />
          <div>
            <h1 class="text-xl font-bold text-text">Qã¡ã‚ƒã‚“</h1>
            <p class="text-sm text-text-muted">TGNã®ã“ã¨ãªã‚‰ä½•ã§ã‚‚èã„ã¦ã­ï¼</p>
          </div>
          <div class="ml-auto flex items-center gap-2">
            <span id="status-indicator" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
            <span class="text-xs text-text-muted">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
    <div id="chat-messages" class="flex-1 overflow-y-auto">
      <div class="container py-6 space-y-4 max-w-3xl mx-auto">
        <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="flex gap-3" id="initial-message">
          <img src="/images/QxQ-02.png" alt="Qã¡ã‚ƒã‚“" class="w-10 h-10 rounded-full flex-shrink-0 shadow-sm" />
          <div class="flex-1">
            <div class="bg-white rounded-2xl rounded-tl-none p-4 shadow-sm max-w-lg">
              <p class="text-text">
                ã“ã‚“ã«ã¡ã¯ï¼ç§ã¯Qã¡ã‚ƒã‚“ã€TGNã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã ã‚ˆğŸ˜Š<br><br>
                TGNã«ã¤ã„ã¦æ°—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Œã°ã€ãªã‚“ã§ã‚‚èã„ã¦ãã ã•ã„ã­ï¼<br>
                ä¾‹ãˆã°...
              </p>
            </div>
            <!-- ã‚µã‚¸ã‚§ã‚¹ãƒˆãƒœã‚¿ãƒ³ -->
            <div class="mt-3 flex flex-wrap gap-2">
              <button class="suggest-btn px-3 py-1.5 bg-white border border-primary/30 text-primary text-sm rounded-full hover:bg-primary/10 transition-colors">
                TGNã£ã¦ä½•ï¼Ÿ
              </button>
              <button class="suggest-btn px-3 py-1.5 bg-white border border-primary/30 text-primary text-sm rounded-full hover:bg-primary/10 transition-colors">
                ã©ã‚“ãªã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚‹ã®ï¼Ÿ
              </button>
              <button class="suggest-btn px-3 py-1.5 bg-white border border-primary/30 text-primary text-sm rounded-full hover:bg-primary/10 transition-colors">
                å‚åŠ æ–¹æ³•ã‚’æ•™ãˆã¦
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="bg-white border-t shadow-lg sticky bottom-0">
      <div class="container py-4 max-w-3xl mx-auto">
        <form id="chat-form" class="flex gap-3">
          <input
            type="text"
            id="chat-input"
            placeholder="TGNã«ã¤ã„ã¦è³ªå•ã—ã¦ã¿ã‚ˆã†..."
            class="flex-1 px-5 py-3 border border-gray-200 rounded-full focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
            autocomplete="off"
            maxlength="500"
          />
          <button
            type="submit"
            id="send-btn"
            class="w-12 h-12 bg-primary text-white rounded-full flex items-center justify-center hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          </button>
        </form>
        <p class="text-xs text-gray-400 mt-2 text-center">
          Powered by Gemini AI |
          <a href="mailto:tsukuba.graduate@gmail.com" class="hover:text-primary">ãŠå•ã„åˆã‚ã›</a>
        </p>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  interface Source {
    title: string;
    url: string;
  }

  interface ChatMessage {
    role: string;
    parts: { text: string }[];
  }

  const form = document.getElementById('chat-form') as HTMLFormElement;
  const input = document.getElementById('chat-input') as HTMLInputElement;
  const messagesContainer = document.getElementById('chat-messages');
  const sendBtn = document.getElementById('send-btn') as HTMLButtonElement;
  const suggestBtns = document.querySelectorAll('.suggest-btn');

  let sessionId: string | null = null;
  let conversationHistory: ChatMessage[] = [];

  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
  function addMessage(text: string, isUser: boolean, sources?: Source[]) {
    const container = messagesContainer?.querySelector('.container');
    if (!container) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = `flex gap-3 ${isUser ? 'flex-row-reverse' : ''}`;

    // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ”¹è¡Œã§åˆ†å‰²ã—ã¦HTMLã«å¤‰æ›
    const formattedText = escapeHtml(text).replace(/\n/g, '<br>');

    if (isUser) {
      messageDiv.innerHTML = `
        <div class="bg-primary text-white rounded-2xl rounded-tr-none p-4 shadow-sm max-w-lg">
          <p>${formattedText}</p>
        </div>
      `;
    } else {
      let sourcesHtml = '';
      if (sources && sources.length > 0) {
        sourcesHtml = `
          <div class="mt-3 flex flex-wrap gap-2">
            ${sources.map(s => `
              <a href="${s.url}" class="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 text-text-muted text-xs rounded-full hover:bg-gray-200 transition-colors">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
                ${escapeHtml(s.title)}
              </a>
            `).join('')}
          </div>
        `;
      }

      messageDiv.innerHTML = `
        <img src="/images/QxQ-02.png" alt="Qã¡ã‚ƒã‚“" class="w-10 h-10 rounded-full flex-shrink-0 shadow-sm" />
        <div class="flex-1">
          <div class="bg-white rounded-2xl rounded-tl-none p-4 shadow-sm max-w-lg">
            <p class="text-text">${formattedText}</p>
          </div>
          ${sourcesHtml}
        </div>
      `;
    }

    container.appendChild(messageDiv);
    scrollToBottom();
  }

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  function addLoadingMessage(): HTMLElement {
    const container = messagesContainer?.querySelector('.container');
    if (!container) return document.createElement('div');

    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-message';
    loadingDiv.className = 'flex gap-3';
    loadingDiv.innerHTML = `
      <img src="/images/QxQ-02.png" alt="Qã¡ã‚ƒã‚“" class="w-10 h-10 rounded-full flex-shrink-0 shadow-sm" />
      <div class="bg-white rounded-2xl rounded-tl-none p-4 shadow-sm">
        <div class="flex gap-1.5">
          <span class="w-2.5 h-2.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
          <span class="w-2.5 h-2.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
          <span class="w-2.5 h-2.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
        </div>
      </div>
    `;
    container.appendChild(loadingDiv);
    scrollToBottom();
    return loadingDiv;
  }

  function removeLoadingMessage() {
    document.getElementById('loading-message')?.remove();
  }

  function scrollToBottom() {
    messagesContainer?.scrollTo({
      top: messagesContainer.scrollHeight,
      behavior: 'smooth'
    });
  }

  // APIã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
  async function sendMessage(message: string): Promise<{ reply: string; sources?: Source[]; sessionId?: string }> {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message,
        sessionId,
        history: conversationHistory
      })
    });

    const data = await response.json();

    if (data.sessionId) {
      sessionId = data.sessionId;
    }

    return data;
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†
  async function handleSubmit(message: string) {
    if (!message.trim()) return;

    // ã‚µã‚¸ã‚§ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
    document.getElementById('initial-message')?.querySelector('.flex.flex-wrap')?.remove();

    // å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
    input.value = '';
    input.disabled = true;
    sendBtn.disabled = true;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    addMessage(message, true);

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    addLoadingMessage();

    try {
      const result = await sendMessage(message);

      // ä¼šè©±å±¥æ­´ã‚’æ›´æ–°
      conversationHistory.push({
        role: 'user',
        parts: [{ text: message }]
      });

      if (result.reply) {
        conversationHistory.push({
          role: 'model',
          parts: [{ text: result.reply }]
        });
      }

      removeLoadingMessage();
      addMessage(result.reply || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', false, result.sources);
    } catch (error) {
      console.error('Chat error:', error);
      removeLoadingMessage();
      addMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¡ã‚ƒã£ãŸğŸ˜¢ ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­ï¼', false);
    }

    // å…¥åŠ›ã‚’æœ‰åŠ¹åŒ–
    input.disabled = false;
    sendBtn.disabled = false;
    input.focus();
  }

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    await handleSubmit(input.value);
  });

  // ã‚µã‚¸ã‚§ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯
  suggestBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const text = btn.textContent?.trim();
      if (text) {
        await handleSubmit(text);
      }
    });
  });

  // Enterã‚­ãƒ¼ã§ã®é€ä¿¡
  input?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      form?.dispatchEvent(new Event('submit'));
    }
  });
</script>

<style>
  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-6px); }
  }

  /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  #chat-messages::-webkit-scrollbar {
    width: 6px;
  }

  #chat-messages::-webkit-scrollbar-track {
    background: transparent;
  }

  #chat-messages::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }

  #chat-messages::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
</style>
