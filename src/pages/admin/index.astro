---
// 管理画面 - クライアントサイドで認証・操作
---

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>管理画面 | TGN</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f5f5f5;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* Login */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .login-box {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }

    .login-title {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 1.5rem;
      color: #0D9488;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #374151;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: inherit;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: #0D9488;
      box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
    }

    .form-textarea {
      min-height: 200px;
      resize: vertical;
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #0D9488;
      color: white;
    }

    .btn-primary:hover {
      background: #0f766e;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-full {
      width: 100%;
    }

    .error {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    /* Dashboard */
    .dashboard {
      display: none;
    }

    .header {
      background: white;
      padding: 1rem 0;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 2rem;
    }

    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: #0D9488;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      border: none;
      background: white;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 500;
      color: #6b7280;
    }

    .tab.active {
      background: #0D9488;
      color: white;
    }

    /* Posts List */
    .posts-grid {
      display: grid;
      gap: 1rem;
    }

    .post-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: start;
      gap: 1rem;
    }

    .post-info h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .post-meta {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .post-actions {
      display: flex;
      gap: 0.5rem;
    }

    .badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      font-size: 0.75rem;
      border-radius: 9999px;
      background: #e5e7eb;
    }

    .badge-info { background: #0D9488; color: white; }
    .badge-event { background: #F97316; color: white; }

    /* Editor */
    .editor-container {
      display: none;
      background: white;
      padding: 2rem;
      border-radius: 1rem;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .editor-title {
      font-size: 1.25rem;
      font-weight: bold;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 640px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .hidden {
      display: none !important;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="login-container">
    <div class="login-box">
      <h1 class="login-title">TGN 管理画面</h1>
      <form id="login-form">
        <div class="form-group">
          <label class="form-label" for="password">パスワード</label>
          <input type="password" id="password" class="form-input" placeholder="パスワードを入力" required />
        </div>
        <div id="login-error" class="error hidden"></div>
        <button type="submit" class="btn btn-primary btn-full" style="margin-top: 1rem;">
          ログイン
        </button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">
    <header class="header">
      <div class="container header-inner">
        <h1 class="header-title">TGN 管理画面</h1>
        <div class="header-actions">
          <a href="/" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
            サイトを見る
          </a>
          <button id="logout-btn" class="btn" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
            ログアウト
          </button>
        </div>
      </div>
    </header>

    <main class="container" style="padding-bottom: 2rem;">
      <!-- Posts List View -->
      <div id="posts-view">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2 style="font-size: 1.5rem; font-weight: bold;">記事一覧</h2>
          <button id="new-post-btn" class="btn btn-primary">新規作成</button>
        </div>

        <div id="posts-list" class="posts-grid">
          <div class="loading">読み込み中...</div>
        </div>
      </div>

      <!-- Editor View -->
      <div id="editor-view" class="editor-container">
        <div class="editor-header">
          <h2 id="editor-title" class="editor-title">新規記事</h2>
          <button id="back-btn" class="btn btn-secondary">戻る</button>
        </div>

        <form id="post-form">
          <input type="hidden" id="post-id" />

          <div class="form-group">
            <label class="form-label" for="post-title">タイトル *</label>
            <input type="text" id="post-title" class="form-input" required />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="post-category">カテゴリ</label>
              <select id="post-category" class="form-select">
                <option value="info">お知らせ</option>
                <option value="event">イベント</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="post-date">公開日</label>
              <input type="date" id="post-date" class="form-input" />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">画像</label>
            <div style="display: flex; gap: 0.5rem; align-items: start;">
              <div style="flex: 1;">
                <input type="file" id="image-upload" accept="image/*" class="form-input" style="padding: 0.5rem;" />
                <input type="hidden" id="post-image" />
                <div id="upload-status" style="font-size: 0.875rem; margin-top: 0.25rem;"></div>
              </div>
              <div id="image-preview" style="width: 100px; height: 100px; border: 1px solid #d1d5db; border-radius: 0.5rem; overflow: hidden; display: none;">
                <img id="preview-img" style="width: 100%; height: 100%; object-fit: cover;" />
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="post-content">本文 *</label>
            <textarea id="post-content" class="form-textarea" required></textarea>
          </div>

          <div id="form-error" class="error hidden"></div>

          <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button type="submit" class="btn btn-primary">保存</button>
            <button type="button" id="delete-btn" class="btn btn-danger hidden">削除</button>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    // State
    let isAuthenticated = false;
    let posts = [];
    let editingPostId = null;

    // Elements
    const loginScreen = document.getElementById('login-screen');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const postsView = document.getElementById('posts-view');
    const editorView = document.getElementById('editor-view');
    const postsList = document.getElementById('posts-list');
    const postForm = document.getElementById('post-form');
    const formError = document.getElementById('form-error');

    // Check auth on load
    async function checkAuth() {
      try {
        const res = await fetch('/api/auth');
        const data = await res.json();
        if (data.authenticated) {
          showDashboard();
          loadPosts();
        }
      } catch {}
    }

    // Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;

      try {
        const res = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();

        if (data.success) {
          showDashboard();
          loadPosts();
        } else {
          showError(loginError, data.error || 'ログインに失敗しました');
        }
      } catch {
        showError(loginError, 'サーバーエラーが発生しました');
      }
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', () => {
      document.cookie = 'auth_token=; Path=/; Max-Age=0';
      location.reload();
    });

    // Show dashboard
    function showDashboard() {
      loginScreen.style.display = 'none';
      dashboard.style.display = 'block';
    }

    // Load posts
    async function loadPosts() {
      try {
        const res = await fetch('/api/posts');
        posts = await res.json();
        renderPosts();
      } catch {
        postsList.innerHTML = '<div class="loading">記事の読み込みに失敗しました</div>';
      }
    }

    // Render posts
    function renderPosts() {
      if (posts.length === 0) {
        postsList.innerHTML = '<div class="loading">記事がありません</div>';
        return;
      }

      postsList.innerHTML = posts.map(post => `
        <div class="post-card">
          <div class="post-info">
            <span class="badge ${post.category === 'event' ? 'badge-event' : 'badge-info'}">
              ${post.category === 'event' ? 'イベント' : 'お知らせ'}
            </span>
            <h3>${escapeHtml(post.title)}</h3>
            <p class="post-meta">${formatDate(post.created_at)}</p>
          </div>
          <div class="post-actions">
            <button class="btn btn-secondary" onclick="editPost(${post.id})" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
              編集
            </button>
          </div>
        </div>
      `).join('');
    }

    // New post
    document.getElementById('new-post-btn').addEventListener('click', () => {
      editingPostId = null;
      document.getElementById('editor-title').textContent = '新規記事';
      document.getElementById('post-id').value = '';
      document.getElementById('post-title').value = '';
      document.getElementById('post-content').value = '';
      document.getElementById('post-category').value = 'info';
      document.getElementById('post-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('post-image').value = '';
      document.getElementById('image-upload').value = '';
      document.getElementById('upload-status').textContent = '';
      document.getElementById('image-preview').style.display = 'none';
      document.getElementById('delete-btn').classList.add('hidden');
      showEditor();
    });

    // Edit post
    window.editPost = function(id) {
      const post = posts.find(p => p.id === id);
      if (!post) return;

      editingPostId = id;
      document.getElementById('editor-title').textContent = '記事を編集';
      document.getElementById('post-id').value = post.id;
      document.getElementById('post-title').value = post.title;
      document.getElementById('post-content').value = post.content;
      document.getElementById('post-category').value = post.category;
      // 日付を設定（published_atがあればそれを、なければcreated_atを使用）
      const postDate = post.published_at || post.created_at;
      document.getElementById('post-date').value = postDate ? postDate.split('T')[0] : new Date().toISOString().split('T')[0];
      document.getElementById('post-image').value = post.image_url || '';
      document.getElementById('image-upload').value = '';
      document.getElementById('upload-status').textContent = '';

      // 画像プレビュー
      if (post.image_url) {
        document.getElementById('preview-img').src = post.image_url;
        document.getElementById('image-preview').style.display = 'block';
      } else {
        document.getElementById('image-preview').style.display = 'none';
      }

      document.getElementById('delete-btn').classList.remove('hidden');
      showEditor();
    };

    // 画像アップロード
    document.getElementById('image-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const statusEl = document.getElementById('upload-status');
      statusEl.textContent = 'アップロード中...';
      statusEl.style.color = '#6b7280';

      try {
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById('post-image').value = data.url;
          document.getElementById('preview-img').src = data.url;
          document.getElementById('image-preview').style.display = 'block';
          statusEl.textContent = 'アップロード完了';
          statusEl.style.color = '#10b981';
        } else {
          statusEl.textContent = data.error || 'アップロード失敗';
          statusEl.style.color = '#ef4444';
        }
      } catch {
        statusEl.textContent = 'アップロードエラー';
        statusEl.style.color = '#ef4444';
      }
    });

    // Save post
    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const postData = {
        id: editingPostId,
        title: document.getElementById('post-title').value,
        content: document.getElementById('post-content').value,
        category: document.getElementById('post-category').value,
        image_url: document.getElementById('post-image').value || null,
        published_at: document.getElementById('post-date').value || null
      };

      try {
        const res = await fetch('/api/posts', {
          method: editingPostId ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(postData)
        });
        const data = await res.json();

        if (data.success || data.id) {
          showPostsList();
          loadPosts();
        } else {
          showError(formError, data.error || '保存に失敗しました');
        }
      } catch {
        showError(formError, 'サーバーエラーが発生しました');
      }
    });

    // Delete post
    document.getElementById('delete-btn').addEventListener('click', async () => {
      if (!editingPostId || !confirm('この記事を削除しますか？')) return;

      try {
        const res = await fetch(`/api/posts?id=${editingPostId}`, {
          method: 'DELETE'
        });
        const data = await res.json();

        if (data.success) {
          showPostsList();
          loadPosts();
        } else {
          showError(formError, data.error || '削除に失敗しました');
        }
      } catch {
        showError(formError, 'サーバーエラーが発生しました');
      }
    });

    // Back to list
    document.getElementById('back-btn').addEventListener('click', showPostsList);

    // View toggles
    function showEditor() {
      postsView.style.display = 'none';
      editorView.style.display = 'block';
      formError.classList.add('hidden');
    }

    function showPostsList() {
      postsView.style.display = 'block';
      editorView.style.display = 'none';
    }

    // Helpers
    function showError(el, msg) {
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('ja-JP', {
        year: 'numeric', month: 'long', day: 'numeric'
      });
    }

    // Init
    checkAuth();
  </script>
</body>
</html>
