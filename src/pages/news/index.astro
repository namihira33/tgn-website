---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SectionHeader from '../../components/ui/SectionHeader.astro';
import { getUnifiedNews, formatDate, type CategoryType } from '../../lib/news';

const allNews = await getUnifiedNews();

const defaultImage = '/images/logo.jpg';

function getCategoryLabel(category: CategoryType) {
  switch (category) {
    case 'event': return 'イベント';
    case 'note': return 'note';
    default: return 'お知らせ';
  }
}

function getCategoryClass(category: CategoryType) {
  switch (category) {
    case 'note': return 'badge-note';
    case 'event': return 'badge-event';
    default: return 'badge-info';
  }
}
---

<BaseLayout title="NEWS" description="つくば院生ネットワーク（TGN）の最新ニュース・イベント情報">
  <section class="section">
    <div class="container">
      <SectionHeader
        title="NEWS"
        subtitle="最新のお知らせ・イベント情報"
      />

      <div id="news-list" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {allNews.map((news, index) => (
          <a
            href={news.href}
            target={news.isExternal ? '_blank' : undefined}
            rel={news.isExternal ? 'noopener noreferrer' : undefined}
            class="card group fade-in overflow-hidden news-card"
            style={`transition-delay: ${Math.min(index, 10) * 50}ms`}
            data-date={news.date.toISOString()}
          >
            <div class="aspect-video relative overflow-hidden bg-gray-100">
              <img
                src={news.image || defaultImage}
                alt=""
                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                loading="lazy"
              />
              {news.isExternal && (
                <div class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                </div>
              )}
            </div>
            <div class="p-4">
              <div class="flex flex-wrap items-center gap-2 mb-2">
                {news.categories.map((cat) => (
                  <span class={`badge-tag ${getCategoryClass(cat)}`}>
                    {getCategoryLabel(cat)}
                  </span>
                ))}
                <time class="text-xs text-text-muted">
                  {formatDate(news.date)}
                </time>
              </div>
              <h2 class="font-bold text-lg text-text group-hover:text-primary transition-colors line-clamp-2">
                {news.title}
              </h2>
              {news.description && (
                <p class="mt-2 text-sm text-text-muted line-clamp-2">
                  {news.description}
                </p>
              )}
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // 管理画面投稿をAPIから取得して追加
  async function loadAdminPosts() {
    const defaultImage = '/images/logo.jpg';

    try {
      const response = await fetch('/api/posts');
      console.log('[NEWS] API Response status:', response.status);

      if (!response.ok) {
        console.log('[NEWS] API not available');
        return;
      }

      const data = await response.json();
      console.log('[NEWS] API Response data:', data);

      const posts = data.posts || [];
      console.log('[NEWS] Posts count:', posts.length);

      if (posts.length === 0) {
        console.log('[NEWS] No admin posts found');
        return;
      }

      const grid = document.getElementById('news-list');
      if (!grid) {
        console.log('[NEWS] Grid not found');
        return;
      }

      // 既存のカードから情報を抽出して新しいカードを作成
      const existingCards = grid.querySelectorAll('.news-card');
      console.log('[NEWS] Existing cards:', existingCards.length);

      const existingNews = Array.from(existingCards).map(card => {
        const dateStr = card.getAttribute('data-date') || '1970-01-01';
        const date = new Date(dateStr);
        const href = card.getAttribute('href') || '#';
        const isExternal = card.getAttribute('target') === '_blank';
        const img = card.querySelector('img');
        const imageUrl = img ? img.getAttribute('src') : defaultImage;
        const titleEl = card.querySelector('h2');
        const title = titleEl?.textContent || '';
        const descEl = card.querySelector('p');
        const description = descEl?.textContent || '';
        const badgeEl = card.querySelector('.badge-tag');
        const badgeText = badgeEl?.textContent || 'お知らせ';
        const badgeClass = badgeEl?.className || '';

        // バッジの色を判定
        let badgeColor = '#2563eb'; // デフォルト: info
        if (badgeClass.includes('badge-event')) badgeColor = '#f59e0b';
        if (badgeClass.includes('badge-note')) badgeColor = '#41C9B4';

        const formattedDate = new Intl.DateTimeFormat('ja-JP', {
          year: 'numeric', month: 'long', day: 'numeric'
        }).format(date);

        // 新しいカードを作成（インラインスタイル）
        const newCard = document.createElement('a');
        newCard.href = href;
        if (isExternal) {
          newCard.target = '_blank';
          newCard.rel = 'noopener noreferrer';
        }
        newCard.setAttribute('data-date', dateStr);
        newCard.style.cssText = 'display:block; background:#fff; border-radius:0.75rem; box-shadow:0 1px 3px rgba(0,0,0,0.1); overflow:hidden; transition:transform 0.2s, box-shadow 0.2s; text-decoration:none;';

        const externalIcon = isExternal ? `<div style="position:absolute; top:0.5rem; right:0.5rem; background:rgba(0,0,0,0.5); color:white; padding:0.25rem; border-radius:0.25rem;"><svg style="width:1rem; height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></div>` : '';

        newCard.innerHTML = `
          <div style="aspect-ratio:16/9; position:relative; overflow:hidden; background:#f3f4f6;">
            <img src="${imageUrl}" alt="" style="width:100%; height:100%; object-fit:cover;" loading="lazy" />
            ${externalIcon}
          </div>
          <div style="padding:1rem;">
            <div style="display:flex; flex-wrap:wrap; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
              <span style="display:inline-block; padding:0.125rem 0.5rem; font-size:0.75rem; font-weight:500; border-radius:9999px; background:${badgeColor}; color:white;">${badgeText}</span>
              <time style="font-size:0.75rem; color:#6b7280;">${formattedDate}</time>
            </div>
            <h2 style="font-weight:700; font-size:1.125rem; color:#1a1a1a; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${title}</h2>
            ${description ? `<p style="margin-top:0.5rem; font-size:0.875rem; color:#6b7280; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${description}</p>` : ''}
          </div>
        `;

        newCard.onmouseenter = () => { newCard.style.transform = 'translateY(-4px)'; newCard.style.boxShadow = '0 10px 25px rgba(0,0,0,0.15)'; };
        newCard.onmouseleave = () => { newCard.style.transform = ''; newCard.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)'; };

        return {
          element: newCard,
          date: date
        };
      });

      // admin投稿をカードに変換
      const adminCards = posts.map(post => {
        console.log('[NEWS] Creating card for post:', post.id, post.title);

        const date = new Date(post.created_at);
        const dateStr = new Intl.DateTimeFormat('ja-JP', {
          year: 'numeric', month: 'long', day: 'numeric'
        }).format(date);

        const imageUrl = post.image_url || defaultImage;
        const category = post.category || 'info';
        const categoryLabel = category === 'event' ? 'イベント' : 'お知らせ';
        const badgeColor = category === 'event' ? '#f59e0b' : '#2563eb';
        const description = post.content ? post.content.substring(0, 100) + '...' : '';

        const card = document.createElement('a');
        card.href = '/news/admin/' + post.id;
        card.setAttribute('data-date', post.created_at);
        card.style.cssText = 'display:block; background:#fff; border-radius:0.75rem; box-shadow:0 1px 3px rgba(0,0,0,0.1); overflow:hidden; transition:transform 0.2s, box-shadow 0.2s; text-decoration:none;';

        card.innerHTML = `
          <div style="aspect-ratio:16/9; position:relative; overflow:hidden; background:#f3f4f6;">
            <img src="${imageUrl}" alt="" style="width:100%; height:100%; object-fit:cover;" loading="lazy" />
          </div>
          <div style="padding:1rem;">
            <div style="display:flex; flex-wrap:wrap; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
              <span style="display:inline-block; padding:0.125rem 0.5rem; font-size:0.75rem; font-weight:500; border-radius:9999px; background:${badgeColor}; color:white;">${categoryLabel}</span>
              <time style="font-size:0.75rem; color:#6b7280;">${dateStr}</time>
            </div>
            <h2 style="font-weight:700; font-size:1.125rem; color:#1a1a1a; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${post.title}</h2>
            ${description ? `<p style="margin-top:0.5rem; font-size:0.875rem; color:#6b7280; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${description}</p>` : ''}
          </div>
        `;

        card.onmouseenter = () => { card.style.transform = 'translateY(-4px)'; card.style.boxShadow = '0 10px 25px rgba(0,0,0,0.15)'; };
        card.onmouseleave = () => { card.style.transform = ''; card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)'; };

        return {
          element: card,
          date: date
        };
      });

      // 全て結合して日付順にソート
      const allCards = [...existingNews, ...adminCards]
        .sort((a, b) => b.date.getTime() - a.date.getTime());

      console.log('[NEWS] Total cards after merge:', allCards.length);

      // グリッドを再構築
      grid.innerHTML = '';
      allCards.forEach((item, index) => {
        item.element.style.transitionDelay = (Math.min(index, 10) * 50) + 'ms';
        grid.appendChild(item.element);
      });

      console.log('[NEWS] Grid updated successfully');
    } catch (error) {
      console.error('[NEWS] Failed to load admin posts:', error);
    }
  }

  // ページ読み込み時に実行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadAdminPosts);
  } else {
    loadAdminPosts();
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .badge-tag {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 9999px;
  }

  .badge-note {
    background-color: #41C9B4;
    color: white;
  }

  .badge-event {
    background-color: var(--color-secondary);
    color: white;
  }

  .badge-info {
    background-color: var(--color-primary);
    color: white;
  }
</style>
