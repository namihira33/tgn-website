---
// TGNAI (Qã¡ã‚ƒã‚“) ç´¹ä»‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ç”¨ï¼‰- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ä»˜ã
---

<section class="section bg-gradient-to-br from-primary/5 to-secondary/5">
  <div class="container">
    <div class="max-w-4xl mx-auto">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <!-- TGNAI ç”»åƒ -->
        <div class="text-center">
          <img
            src="/images/QxQ-02.png"
            alt="Qã¡ã‚ƒã‚“ - TGNå¯¾è©±AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ"
            class="w-48 h-48 mx-auto rounded-full shadow-xl border-4 border-white"
          />
        </div>

        <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
        <div>
          <h2 class="text-2xl md:text-3xl font-bold text-text mb-4">
            Qã¡ã‚ƒã‚“ã«èã„ã¦ã¿ã‚ˆã†!
          </h2>
          <p class="text-text-muted mb-4">
            Qã¡ã‚ƒã‚“ã¯ TGN ã® AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€‚<br />
            TGN ã«ã¤ã„ã¦ã®è³ªå•ã«ç­”ãˆã¦ãã‚Œã‚‹ã‚ˆ!
          </p>

          <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
          <div id="qchan-messages" class="bg-white rounded-xl p-4 shadow-sm mb-4 h-48 overflow-y-auto space-y-3">
            <div class="flex items-start gap-3">
              <img src="/images/QxQ-02.png" alt="Qã¡ã‚ƒã‚“" class="w-8 h-8 rounded-full flex-shrink-0" />
              <div class="bg-gray-100 rounded-lg rounded-tl-none p-3 flex-1">
                <p class="text-sm text-text-muted">
                  ã“ã‚“ã«ã¡ã¯! ç§ã¯Qã¡ã‚ƒã‚“ã€TGNã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã ã‚ˆğŸ˜Š TGNã«ã¤ã„ã¦ä½•ã§ã‚‚èã„ã¦ã­!
                </p>
              </div>
            </div>
          </div>

          <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
          <form id="qchan-form" class="flex gap-2">
            <input
              type="text"
              id="qchan-input"
              placeholder="TGNã«ã¤ã„ã¦è³ªå•ã—ã¦ã¿ã‚ˆã†..."
              class="flex-1 px-4 py-2 border border-gray-200 rounded-full focus:outline-none focus:border-primary text-sm"
              autocomplete="off"
              maxlength="500"
            />
            <button
              type="submit"
              id="qchan-send"
              class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center hover:bg-primary/90 transition-colors disabled:opacity-50"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
            </button>
          </form>

          <div class="flex items-center justify-between mt-3">
            <p class="text-xs text-gray-400">
              Powered by Gemini AI
            </p>
          </div>

          <!-- Qã¡ã‚ƒã‚“ã¨ã‚‚ã£ã¨è©±ã™ãƒœã‚¿ãƒ³ -->
          <a
            href="/qchan"
            class="mt-4 w-full inline-flex items-center justify-center gap-2 px-6 py-3 bg-primary text-white font-semibold rounded-full hover:bg-primary/90 transition-all hover:shadow-lg"
          >
            <img src="/images/QxQ-02.png" alt="" class="w-6 h-6 rounded-full" />
            Qã¡ã‚ƒã‚“ã¨ã‚‚ã£ã¨è©±ã™
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  interface ChatMessage {
    role: string;
    parts: { text: string }[];
  }

  const form = document.getElementById('qchan-form');
  const input = document.getElementById('qchan-input') as HTMLInputElement;
  const messages = document.getElementById('qchan-messages');
  const sendBtn = document.getElementById('qchan-send') as HTMLButtonElement;

  let sessionId: string | null = null;
  let conversationHistory: ChatMessage[] = [];

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function addMessage(text: string, isUser: boolean) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex items-start gap-3 ${isUser ? 'flex-row-reverse' : ''}`;

    const formattedText = escapeHtml(text).replace(/\n/g, '<br>');

    if (isUser) {
      messageDiv.innerHTML = `
        <div class="bg-primary text-white rounded-lg rounded-tr-none p-3 max-w-[80%]">
          <p class="text-sm">${formattedText}</p>
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <img src="/images/QxQ-02.png" alt="Qã¡ã‚ƒã‚“" class="w-8 h-8 rounded-full flex-shrink-0" />
        <div class="bg-gray-100 rounded-lg rounded-tl-none p-3 max-w-[80%]">
          <p class="text-sm text-text-muted">${formattedText}</p>
        </div>
      `;
    }

    messages?.appendChild(messageDiv);
    messages?.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
  }

  function addLoadingMessage() {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-message';
    loadingDiv.className = 'flex items-start gap-3';
    loadingDiv.innerHTML = `
      <img src="/images/QxQ-02.png" alt="Qã¡ã‚ƒã‚“" class="w-8 h-8 rounded-full flex-shrink-0" />
      <div class="bg-gray-100 rounded-lg rounded-tl-none p-3">
        <div class="flex gap-1">
          <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
          <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
          <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
        </div>
      </div>
    `;
    messages?.appendChild(loadingDiv);
    messages?.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
  }

  function removeLoadingMessage() {
    document.getElementById('loading-message')?.remove();
  }

  async function sendToChat(userMessage: string): Promise<string> {
    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: userMessage,
          sessionId,
          history: conversationHistory
        })
      });

      const data = await response.json();

      if (data.sessionId) {
        sessionId = data.sessionId;
      }

      if (data.success && data.reply) {
        conversationHistory.push({
          role: 'user',
          parts: [{ text: userMessage }]
        });
        conversationHistory.push({
          role: 'model',
          parts: [{ text: data.reply }]
        });
        return data.reply;
      }

      return data.reply || 'ã”ã‚ã‚“ã­ã€ã¡ã‚‡ã£ã¨ã†ã¾ãç­”ãˆã‚‰ã‚Œãªã‹ã£ãŸã¿ãŸã„ğŸ˜… ã‚‚ã†ä¸€åº¦èã„ã¦ãã‚Œã‚‹?';
    } catch (error) {
      console.error('Chat API error:', error);
      return 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¡ã‚ƒã£ãŸğŸ˜¢ ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­!';
    }
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userMessage = input?.value.trim();
    if (!userMessage) return;

    input.value = '';
    sendBtn.disabled = true;

    addMessage(userMessage, true);
    addLoadingMessage();

    const response = await sendToChat(userMessage);

    removeLoadingMessage();
    addMessage(response, false);

    sendBtn.disabled = false;
    input?.focus();
  });
</script>

<style>
  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-6px); }
  }
</style>
