---
import SectionHeader from '../ui/SectionHeader.astro';

// noteのRSSフィードを取得
interface NoteArticle {
  title: string;
  link: string;
  pubDate: string;
  description: string;
}

let noteArticles: NoteArticle[] = [];

try {
  const response = await fetch('https://note.com/tkbgradnet/rss');
  const xml = await response.text();

  // XMLをパース（簡易的な正規表現パース）
  const items = xml.match(/<item>([\s\S]*?)<\/item>/g) || [];

  noteArticles = items.slice(0, 4).map(item => {
    const title = item.match(/<title><!\[CDATA\[(.*?)\]\]><\/title>/)?.[1] ||
                  item.match(/<title>(.*?)<\/title>/)?.[1] || '';
    const link = item.match(/<link>(.*?)<\/link>/)?.[1] || '';
    const pubDate = item.match(/<pubDate>(.*?)<\/pubDate>/)?.[1] || '';
    const description = item.match(/<description><!\[CDATA\[(.*?)\]\]><\/description>/)?.[1] ||
                        item.match(/<description>(.*?)<\/description>/)?.[1] || '';

    return { title, link, pubDate, description };
  });
} catch (error) {
  console.error('Failed to fetch note RSS:', error);
}

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
}
---

<section class="section bg-gray-50">
  <div class="container">
    <SectionHeader
      title="noteで発信中"
      subtitle="TGNの活動や研究紹介をnoteで発信しています"
    />

    {noteArticles.length > 0 ? (
      <div class="grid md:grid-cols-2 gap-6">
        {noteArticles.map((article, index) => (
          <a
            href={article.link}
            target="_blank"
            rel="noopener noreferrer"
            class="card p-6 hover:shadow-lg transition-shadow fade-in group"
            style={`transition-delay: ${index * 100}ms`}
          >
            <div class="flex items-start gap-4">
              <div class="flex-shrink-0 w-12 h-12 bg-[#41C9B4] rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-xs text-text-muted mb-1">{formatDate(article.pubDate)}</p>
                <h3 class="font-bold text-text group-hover:text-primary transition-colors line-clamp-2">
                  {article.title}
                </h3>
              </div>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <p class="text-center text-text-muted">記事を取得できませんでした</p>
    )}

    <div class="text-center mt-8">
      <a
        href="https://note.com/tkbgradnet"
        target="_blank"
        rel="noopener noreferrer"
        class="btn btn-outline inline-flex items-center gap-2"
      >
        noteですべての記事を見る
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
        </svg>
      </a>
    </div>
  </div>
</section>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
