---
// Qã¡ã‚ƒã‚“å¯¾è©±AI - ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
---

<!-- ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
<button
  id="qchan-toggle"
  class="fixed bottom-6 right-6 z-50 w-16 h-16 rounded-full bg-primary shadow-lg hover:shadow-xl transition-all hover:scale-105 flex items-center justify-center"
  aria-label="Qã¡ã‚ƒã‚“ã«è³ªå•ã™ã‚‹"
>
  <img src="/images/QxQ-02.png" alt="Qã¡ã‚ƒã‚“" class="w-12 h-12 rounded-full object-cover" />
</button>

<!-- ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
<div
  id="qchan-chat"
  class="fixed bottom-24 right-6 z-50 w-80 md:w-96 bg-white rounded-2xl shadow-2xl hidden flex-col overflow-hidden"
  style="height: 500px; max-height: calc(100vh - 150px);"
>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="bg-primary text-white p-4 flex items-center gap-3">
    <img src="/images/QxQ-02.png" alt="Qã¡ã‚ƒã‚“" class="w-10 h-10 rounded-full object-cover border-2 border-white" />
    <div class="flex-1">
      <h3 class="font-bold">Qã¡ã‚ƒã‚“</h3>
      <p class="text-xs text-primary-light">TGNã®ã“ã¨ãªã‚‰ãŠã¾ã‹ã›!</p>
    </div>
    <a href="/qchan" class="p-1 hover:bg-white/20 rounded-full transition-colors" title="ãƒ•ãƒ«ãƒšãƒ¼ã‚¸ã§é–‹ã">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
      </svg>
    </a>
    <button id="qchan-close" class="p-1 hover:bg-white/20 rounded-full transition-colors">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
  <div id="qchan-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
    <div class="flex gap-2">
      <img src="/images/QxQ-02.png" alt="Qã¡ã‚ƒã‚“" class="w-8 h-8 rounded-full object-cover flex-shrink-0" />
      <div class="bg-white rounded-lg rounded-tl-none p-3 shadow-sm max-w-[80%]">
        <p class="text-sm">ã“ã‚“ã«ã¡ã¯! ç§ã¯Qã¡ã‚ƒã‚“ã€TGNã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã ã‚ˆğŸ˜Š TGNã«ã¤ã„ã¦ä½•ã§ã‚‚èã„ã¦ã­!</p>
      </div>
    </div>
  </div>

  <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
  <div class="p-4 bg-white border-t">
    <form id="qchan-form" class="flex gap-2">
      <input
        type="text"
        id="qchan-input"
        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
        class="flex-1 px-4 py-2 border border-gray-200 rounded-full focus:outline-none focus:border-primary text-sm"
        autocomplete="off"
        maxlength="500"
      />
      <button
        type="submit"
        class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center hover:bg-primary-dark transition-colors disabled:opacity-50"
        id="qchan-send"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
      </button>
    </form>
    <p class="text-xs text-gray-400 mt-2 text-center">Powered by Gemini AI</p>
  </div>
</div>

<script>
  interface ChatMessage {
    role: string;
    parts: { text: string }[];
  }

  const toggle = document.getElementById('qchan-toggle');
  const chat = document.getElementById('qchan-chat');
  const closeBtn = document.getElementById('qchan-close');
  const form = document.getElementById('qchan-form');
  const input = document.getElementById('qchan-input') as HTMLInputElement;
  const messages = document.getElementById('qchan-messages');
  const sendBtn = document.getElementById('qchan-send') as HTMLButtonElement;

  let isOpen = false;
  let sessionId: string | null = null;
  let conversationHistory: ChatMessage[] = [];

  toggle?.addEventListener('click', () => {
    isOpen = !isOpen;
    chat?.classList.toggle('hidden', !isOpen);
    chat?.classList.toggle('flex', isOpen);
    if (isOpen) input?.focus();
  });

  closeBtn?.addEventListener('click', () => {
    isOpen = false;
    chat?.classList.add('hidden');
    chat?.classList.remove('flex');
  });

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function addMessage(text: string, isUser: boolean) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex gap-2 ${isUser ? 'flex-row-reverse' : ''}`;

    const formattedText = escapeHtml(text).replace(/\n/g, '<br>');

    if (isUser) {
      messageDiv.innerHTML = `
        <div class="bg-primary text-white rounded-lg rounded-tr-none p-3 shadow-sm max-w-[80%]">
          <p class="text-sm">${formattedText}</p>
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <img src="/images/QxQ-02.png" alt="Qã¡ã‚ƒã‚“" class="w-8 h-8 rounded-full object-cover flex-shrink-0" />
        <div class="bg-white rounded-lg rounded-tl-none p-3 shadow-sm max-w-[80%]">
          <p class="text-sm">${formattedText}</p>
        </div>
      `;
    }

    messages?.appendChild(messageDiv);
    messages?.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
  }

  function addLoadingMessage() {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-message';
    loadingDiv.className = 'flex gap-2';
    loadingDiv.innerHTML = `
      <img src="/images/QxQ-02.png" alt="Qã¡ã‚ƒã‚“" class="w-8 h-8 rounded-full object-cover flex-shrink-0" />
      <div class="bg-white rounded-lg rounded-tl-none p-3 shadow-sm">
        <div class="flex gap-1">
          <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
          <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
          <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
        </div>
      </div>
    `;
    messages?.appendChild(loadingDiv);
    messages?.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
  }

  function removeLoadingMessage() {
    document.getElementById('loading-message')?.remove();
  }

  async function sendToChat(userMessage: string): Promise<string> {
    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: userMessage,
          sessionId,
          history: conversationHistory
        })
      });

      const data = await response.json();

      if (data.sessionId) {
        sessionId = data.sessionId;
      }

      if (data.success && data.reply) {
        conversationHistory.push({
          role: 'user',
          parts: [{ text: userMessage }]
        });
        conversationHistory.push({
          role: 'model',
          parts: [{ text: data.reply }]
        });
        return data.reply;
      }

      return data.reply || 'ã¡ã‚‡ã£ã¨ã†ã¾ãç­”ãˆã‚‰ã‚Œãªã‹ã£ãŸã¿ãŸã„ğŸ˜… ã‚‚ã†ä¸€åº¦èã„ã¦ãã‚Œã‚‹?';
    } catch (error) {
      console.error('Chat API error:', error);
      return 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¡ã‚ƒã£ãŸğŸ˜¢ ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­!';
    }
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userMessage = input?.value.trim();
    if (!userMessage) return;

    input.value = '';
    sendBtn.disabled = true;

    addMessage(userMessage, true);
    addLoadingMessage();

    const response = await sendToChat(userMessage);

    removeLoadingMessage();
    addMessage(response, false);

    sendBtn.disabled = false;
    input?.focus();
  });
</script>

<style>
  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-6px); }
  }
</style>
