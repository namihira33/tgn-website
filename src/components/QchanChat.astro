---
// Qちゃん対話AI - Gemini搭載チャットウィジェット
---

<!-- チャットボタン -->
<button
  id="qchan-toggle"
  class="fixed bottom-6 right-6 z-50 w-16 h-16 rounded-full bg-primary shadow-lg hover:shadow-xl transition-all hover:scale-105 flex items-center justify-center"
  aria-label="Qちゃんに質問する"
>
  <img src="/images/QxQ-02.png" alt="Qちゃん" class="w-12 h-12 rounded-full object-cover" />
</button>

<!-- チャットウィンドウ -->
<div
  id="qchan-chat"
  class="fixed bottom-24 right-6 z-50 w-80 md:w-96 bg-white rounded-2xl shadow-2xl hidden flex-col overflow-hidden"
  style="height: 500px; max-height: calc(100vh - 150px);"
>
  <!-- ヘッダー -->
  <div class="bg-primary text-white p-4 flex items-center gap-3">
    <img src="/images/QxQ-02.png" alt="Qちゃん" class="w-10 h-10 rounded-full object-cover border-2 border-white" />
    <div class="flex-1">
      <h3 class="font-bold">Qちゃん</h3>
      <p class="text-xs text-primary-light">TGNのことならおまかせ!</p>
    </div>
    <button id="qchan-close" class="p-1 hover:bg-white/20 rounded-full transition-colors">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- メッセージエリア -->
  <div id="qchan-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
    <div class="flex gap-2">
      <img src="/images/QxQ-02.png" alt="Qちゃん" class="w-8 h-8 rounded-full object-cover flex-shrink-0" />
      <div class="bg-white rounded-lg rounded-tl-none p-3 shadow-sm max-w-[80%]">
        <p class="text-sm">こんにちは! 私はQちゃん、TGNのマスコットキャラクターだよ。TGNについて何でも聞いてね!</p>
      </div>
    </div>
  </div>

  <!-- 入力エリア -->
  <div class="p-4 bg-white border-t">
    <form id="qchan-form" class="flex gap-2">
      <input
        type="text"
        id="qchan-input"
        placeholder="メッセージを入力..."
        class="flex-1 px-4 py-2 border border-gray-200 rounded-full focus:outline-none focus:border-primary text-sm"
        autocomplete="off"
      />
      <button
        type="submit"
        class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center hover:bg-primary-dark transition-colors disabled:opacity-50"
        id="qchan-send"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
      </button>
    </form>
    <p class="text-xs text-gray-400 mt-2 text-center">Powered by Gemini AI</p>
  </div>
</div>

<script>
  // TGNに関する知識ベース
  const TGN_KNOWLEDGE = `
あなたはQちゃん、つくば院生ネットワーク（TGN）のマスコットキャラクターです。
TGNは2011年に設立された筑波大学の大学院生による異分野交流団体です。

【TGNの主な活動】
- 院生ひろば: 院生同士が悩みや経験を共有するグループディスカッション。テーマ別に分かれて意味のあるつながりを作ります。
- 院生の虎: 3人の審査員に自分の研究をプレゼンし、異分野の視点からフィードバックを受ける企画。
- 院生花見: 春の恒例イベント。桜の下で分野を超えた院生同士がゆるく交流します。
- つくばQxQ: 異分野研究交流イベント。

【TGNの理念】
「大学院生に、もう一つのコミュニティを」
研究室の外で同じ大学院生として悩みや経験を共有できる場を作っています。

【実績】
- 設立から13年以上の活動継続
- 「みんなの学会」クラウドファンディング85万円達成
- 副学長特別表彰・優秀賞を複数回受賞
- 活動が学術論文として発表

【参加方法】
TGNのイベントは筑波大学の大学院生なら誰でも参加できます。
公式サイト: https://tgn.official.jp
X (Twitter): @TGN_tsukuba
メール: tsukuba.graduate@gmail.com

親しみやすく、フレンドリーな口調で回答してください。語尾に「〜だよ」「〜ね」などを使ってください。
質問に関連する情報を簡潔に答えてください。分からないことは正直に「ごめんね、それは分からないや」と答えてください。
`;

  const toggle = document.getElementById('qchan-toggle');
  const chat = document.getElementById('qchan-chat');
  const closeBtn = document.getElementById('qchan-close');
  const form = document.getElementById('qchan-form');
  const input = document.getElementById('qchan-input') as HTMLInputElement;
  const messages = document.getElementById('qchan-messages');
  const sendBtn = document.getElementById('qchan-send') as HTMLButtonElement;

  let isOpen = false;
  let conversationHistory: { role: string; parts: { text: string }[] }[] = [];

  toggle?.addEventListener('click', () => {
    isOpen = !isOpen;
    chat?.classList.toggle('hidden', !isOpen);
    chat?.classList.toggle('flex', isOpen);
    if (isOpen) input?.focus();
  });

  closeBtn?.addEventListener('click', () => {
    isOpen = false;
    chat?.classList.add('hidden');
    chat?.classList.remove('flex');
  });

  function addMessage(text: string, isUser: boolean) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex gap-2 ${isUser ? 'flex-row-reverse' : ''}`;

    if (isUser) {
      messageDiv.innerHTML = `
        <div class="bg-primary text-white rounded-lg rounded-tr-none p-3 shadow-sm max-w-[80%]">
          <p class="text-sm">${text}</p>
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <img src="/images/QxQ-02.png" alt="Qちゃん" class="w-8 h-8 rounded-full object-cover flex-shrink-0" />
        <div class="bg-white rounded-lg rounded-tl-none p-3 shadow-sm max-w-[80%]">
          <p class="text-sm">${text}</p>
        </div>
      `;
    }

    messages?.appendChild(messageDiv);
    messages?.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
  }

  function addLoadingMessage() {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-message';
    loadingDiv.className = 'flex gap-2';
    loadingDiv.innerHTML = `
      <img src="/images/QxQ-02.png" alt="Qちゃん" class="w-8 h-8 rounded-full object-cover flex-shrink-0" />
      <div class="bg-white rounded-lg rounded-tl-none p-3 shadow-sm">
        <div class="flex gap-1">
          <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
          <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
          <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
        </div>
      </div>
    `;
    messages?.appendChild(loadingDiv);
    messages?.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
  }

  function removeLoadingMessage() {
    document.getElementById('loading-message')?.remove();
  }

  async function sendToGemini(userMessage: string): Promise<string> {
    // Google AI Studio API Key
    const API_KEY = 'AIzaSyCYZhVCvuNRuozns0U_ff9d6QiIo2hpeps';

    conversationHistory.push({
      role: 'user',
      parts: [{ text: userMessage }]
    });

    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            systemInstruction: {
              parts: [{ text: TGN_KNOWLEDGE }]
            },
            contents: conversationHistory,
            generationConfig: {
              temperature: 0.7,
              maxOutputTokens: 500
            }
          })
        }
      );

      const data = await response.json();

      if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
        const aiResponse = data.candidates[0].content.parts[0].text;
        conversationHistory.push({
          role: 'model',
          parts: [{ text: aiResponse }]
        });
        return aiResponse;
      }

      return 'ちょっとうまく答えられなかったみたい。もう一度聞いてくれる?';
    } catch (error) {
      console.error('Gemini API error:', error);
      return 'ネットワークエラーが起きちゃった。しばらくしてからもう一度試してね!';
    }
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userMessage = input?.value.trim();
    if (!userMessage) return;

    input.value = '';
    sendBtn.disabled = true;

    addMessage(userMessage, true);
    addLoadingMessage();

    const response = await sendToGemini(userMessage);

    removeLoadingMessage();
    addMessage(response, false);

    sendBtn.disabled = false;
    input?.focus();
  });
</script>

<style>
  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-6px); }
  }
</style>
